<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Nordic - Admin Panel</title>
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .secure-key-input { font-family: monospace; letter-spacing: 2px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Royal Nordic</h1>
                <p class="text-gray-600">Secure Admin Access</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Email Address *</label>
                    <input type="email" id="email" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="your-email@royalnordic.fi">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Password *</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Your password">
                </div>

                <div>
                    <label class="block text-gray-700 font-medium mb-2">Secure Key *</label>
                    <input type="password" id="secureKey" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent secure-key-input"
                           placeholder="••••••••••••••••"
                           maxlength="16">
                    <p class="text-xs text-gray-500 mt-1">16-character security key</p>
                </div>
                
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Access Admin Panel
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">
                    🔒 This is a secure, private admin panel.<br>
                    Access is restricted to authorized personnel only.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
            <div class="px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold">Royal Nordic Admin Dashboard</h1>
                        <p class="text-blue-100 mt-1">Complete tour management system</p>
                        <p class="text-sm text-blue-200" id="userInfo">Logged in as: admin@royalnordic.fi</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-200">Last updated</div>
                        <div class="text-lg font-semibold" id="lastUpdated">Just now</div>
                        <button id="logoutBtn" class="mt-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            Secure Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Overview -->
        <div class="px-4 py-6">
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2" id="todayBookings">0</div>
                        <div class="text-sm text-gray-600">Bookings Today</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600 mb-2" id="thisWeekBookings">0</div>
                        <div class="text-sm text-gray-600">This Week</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-purple-600 mb-2" id="thisMonthBookings">0</div>
                        <div class="text-sm text-gray-600">This Month</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <div class="text-2xl font-bold text-blue-600" id="totalBookings">0</div>
                    <div class="text-sm text-gray-600">Total Bookings</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <div class="text-2xl font-bold text-green-600" id="confirmedBookings">0</div>
                    <div class="text-sm text-gray-600">Confirmed</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <div class="text-2xl font-bold text-emerald-600" id="totalRevenue">€0</div>
                    <div class="text-sm text-gray-600">Total Revenue</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border">
                    <div class="text-2xl font-bold text-purple-600" id="totalParticipants">0</div>
                    <div class="text-sm text-gray-600">Participants</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="px-4 pb-6">
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onclick="window.open('/admin-availability.html', '_blank')" 
                            class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Manage Availability
                    </button>
                    <button onclick="loadBookings()" 
                            class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh Data
                    </button>
                    <button onclick="exportBookings()" 
                            class="bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export Data
                    </button>
                    <button onclick="showTourManagement()" 
                            class="bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        Tour Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Tour Management Section -->
        <div id="tourManagement" class="px-4 pb-6 hidden">
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Tour Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-medium text-gray-900 mb-3">Northern Lights Tour</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div><span class="font-medium">Season:</span> Sep 15 - Apr 15</div>
                            <div><span class="font-medium">Adult Price:</span> €158</div>
                            <div><span class="font-medium">Child Price:</span> €79</div>
                            <div><span class="font-medium">Max Capacity:</span> 12 people</div>
                            <div><span class="font-medium">Duration:</span> 3-4 hours</div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button onclick="editTour(1)" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                Edit Tour
                            </button>
                            <button onclick="manageAvailability(1)" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                Manage Availability
                            </button>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-medium text-gray-900 mb-3">Snowshoe Adventure</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div><span class="font-medium">Season:</span> Nov 1 - Apr 1</div>
                            <div><span class="font-medium">Adult Price:</span> €95</div>
                            <div><span class="font-medium">Child Price:</span> €48</div>
                            <div><span class="font-medium">Max Capacity:</span> 8 people</div>
                            <div><span class="font-medium">Duration:</span> 2-3 hours</div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button onclick="editTour(2)" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                Edit Tour
                            </button>
                            <button onclick="manageAvailability(2)" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                Manage Availability
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Availability Management Section -->
        <div id="availabilityManagement" class="px-4 pb-6 hidden">
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-gray-900">Tour Availability Management</h2>
                    <button onclick="hideAvailabilityManagement()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Tour Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Tour</label>
                    <select id="tourSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="1">Northern Lights Tour</option>
                        <option value="2">Snowshoe Adventure</option>
                    </select>
                </div>

                <!-- Month Navigation -->
                <div class="flex items-center justify-between mb-6">
                    <button onclick="goToPreviousMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">
                        ← Previous Month
                    </button>
                    <h3 id="currentMonth" class="text-xl font-semibold text-gray-900">September 2025</h3>
                    <button onclick="goToNextMonth()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg">
                        Next Month →
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Sun</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Mon</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Tue</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Wed</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Thu</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Fri</div>
                        <div class="text-center text-sm font-medium text-gray-500 py-2">Sat</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days will be generated here -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="mt-6 flex flex-wrap gap-4 text-sm">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"></div>
                        Available
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></div>
                        Unavailable
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-gray-100 border border-gray-300 rounded mr-2"></div>
                        Past Date
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="px-4 pb-6">
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Search & Filter Bookings</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search by Name/Email</label>
                        <input type="text" id="searchInput" placeholder="Enter name or email..." 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Tour</label>
                        <select id="tourFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Tours</option>
                            <option value="Northern Lights Tour">Northern Lights Tour</option>
                            <option value="Snowshoe Adventure">Snowshoe Adventure</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
                        <select id="statusFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Statuses</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                        <input type="date" id="dateFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                        Apply Filters
                    </button>
                    <button onclick="clearFilters()" class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Bookings List -->
        <div class="px-4 pb-6">
            <div class="bg-white rounded-xl shadow-sm border">
                <div class="p-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-900">Recent Bookings</h2>
                </div>
                
                <div id="bookingsList" class="divide-y divide-gray-200">
                    <!-- Bookings will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Screen (First time only) -->
    <div id="setupScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Setup Admin Access</h1>
                <p class="text-gray-600">Create your secure admin account</p>
            </div>
            
            <form id="setupForm" class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Email Address *</label>
                    <input type="email" id="setupEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="your-email@royalnordic.fi">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Password *</label>
                    <input type="password" id="setupPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Create a strong password">
                </div>

                <div>
                    <label class="block text-gray-700 font-medium mb-2">Secure Key *</label>
                    <input type="password" id="setupSecureKey" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent secure-key-input"
                           placeholder="••••••••••••••••"
                           maxlength="16">
                    <p class="text-xs text-gray-500 mt-1">Create a 16-character security key (save this securely!)</p>
                </div>
                
                <button type="submit" 
                        class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                    Create Secure Admin Account
                </button>
            </form>

            <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <p class="text-sm text-yellow-800">
                    ⚠️ <strong>Important:</strong> Save your secure key somewhere safe!<br>
                    You'll need it every time you access the admin panel.
                </p>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminToken');
        let currentUser = null;

        // Check if admin exists, if not show setup
        async function checkAdminExists() {
            // Skip the check and go straight to login
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Setup admin account
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('setupEmail').value;
            const password = document.getElementById('setupPassword').value;
            const secureKey = document.getElementById('setupSecureKey').value;
            
            if (secureKey.length !== 16) {
                alert('Secure key must be exactly 16 characters long');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, secureKey })
                });
                
                if (response.ok) {
                    alert('Secure admin account created! Save your secure key - you\'ll need it to login.');
                    document.getElementById('setupScreen').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                } else {
                    alert('Error creating admin account');
                }
            } catch (error) {
                alert('Error creating admin account');
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const secureKey = document.getElementById('secureKey').value;
            
            // Simple credential check
            if (email === 'admin@royalnordic.fi' && password === 'Rollonortsu8889' && secureKey === '568907') {
                authToken = 'admin-token';
                currentUser = { id: 1, email: email };
                localStorage.setItem('adminToken', authToken);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                
                document.getElementById('userInfo').textContent = `Logged in as: ${email}`;
                
                loadBookings();
                updateStats();
            } else {
                alert('Invalid credentials. Check your email, password, and secure key.');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('adminToken');
            
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form fields
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('secureKey').value = '';
        });

        // Load bookings
        async function loadBookings() {
            try {
                // Use the Supabase function instead of direct API
                const response = await fetch('https://itihdgqgvlphtyidnvkt.supabase.co/functions/v1/get-tour-availability', {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWhkZ3FndmxwaHR5aWRudmt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTk2NjQsImV4cCI6MjA3MTYzNTY2NH0.pF02EbMsV2Aj03kiyu8eAGAa0QmQ5jCi5JzncJ5T0Rc',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tourId: 1 })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentBookings = data.map(booking => ({
                        id: booking.id,
                        customer_name: booking.customer_name,
                        customer_email: booking.customer_email,
                        customer_phone: booking.customer_phone,
                        adults: booking.adults,
                        children: booking.children,
                        total_price: booking.total_price,
                        status: booking.status,
                        created_at: booking.created_at,
                        special_requests: booking.special_requests || '',
                        tour_name: booking.tour_id === 1 ? 'Northern Lights Tour' : 'Snowshoe Adventure',
                        tour_date: booking.tour_date
                    }));
                    displayBookings(currentBookings);
                    updateStats(currentBookings);
                } else {
                    // Show sample data if API fails
                    const sampleBookings = [
                        {
                            id: 1,
                            customer_name: "Miro Vesterinen",
                            customer_email: "mirov.vesterinen@gmail.com",
                            customer_phone: "+358 40 123 4567",
                            adults: 2,
                            children: 1,
                            total_price: 507,
                            status: "confirmed",
                            created_at: "2025-08-26T15:59:23Z",
                            special_requests: "Vegetarian meals please",
                            tour_name: "Northern Lights Tour",
                            tour_date: "2025-09-15"
                        }
                    ];
                    displayBookings(sampleBookings);
                    updateStats(sampleBookings);
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                // Show sample data on error
                const sampleBookings = [
                    {
                        id: 1,
                        customer_name: "Miro Vesterinen",
                        customer_email: "mirov.vesterinen@gmail.com",
                        customer_phone: "+358 40 123 4567",
                        adults: 2,
                        children: 1,
                        total_price: 507,
                        status: "confirmed",
                        created_at: "2025-08-26T15:59:23Z",
                        special_requests: "Vegetarian meals please",
                        tour_name: "Northern Lights Tour",
                        tour_date: "2025-09-15"
                    }
                ];
                displayBookings(sampleBookings);
                updateStats(sampleBookings);
            }
        }

        // Display bookings
        function displayBookings(bookings) {
            const container = document.getElementById('bookingsList');
            container.innerHTML = '';
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <div class="text-4xl mb-4">📋</div>
                        <p class="text-lg font-medium">No bookings yet</p>
                        <p class="text-sm">When customers start booking tours, they'll appear here</p>
                    </div>
                `;
                return;
            }
            
            bookings.forEach((booking) => {
                const bookingElement = createBookingElement(booking);
                container.appendChild(bookingElement);
            });
        }

        // Create booking element
        function createBookingElement(booking) {
            const div = document.createElement('div');
            div.className = 'p-6 hover:bg-gray-50 transition-colors border-b border-gray-100';
            
            const statusClass = `status-${booking.status.toLowerCase()}`;
            const statusColors = {
                'confirmed': 'bg-green-100 text-green-800',
                'pending': 'bg-yellow-100 text-yellow-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            
            div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-3">
                            <h3 class="text-lg font-semibold text-gray-900">${booking.customer_name}</h3>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColors[booking.status] || 'bg-gray-100 text-gray-800'}">
                                ${booking.status.toUpperCase()}
                            </span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">
                                #${booking.id}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="space-y-2">
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">📧 Email:</span> ${booking.customer_email}
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">📞 Phone:</span> ${booking.customer_phone || 'Not provided'}
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">👥 Participants:</span> ${booking.adults} adults, ${booking.children} children
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">💰 Total Price:</span> €${booking.total_price}
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">🎯 Tour:</span> ${booking.tour_name || 'Unknown Tour'}
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">📅 Tour Date:</span> ${new Date(booking.tour_date).toLocaleDateString('en-GB')}
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">🕒 Booked:</span> ${new Date(booking.created_at).toLocaleString('en-GB')}
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-medium">📊 Total People:</span> ${booking.adults + booking.children}
                                </div>
                            </div>
                        </div>
                        
                        ${booking.special_requests ? `
                            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="text-sm font-medium text-yellow-800 mb-1">💬 Special Requests:</div>
                                <div class="text-sm text-yellow-700">${booking.special_requests}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="ml-6 flex flex-col space-y-2">
                        <select class="status-select border border-gray-300 rounded px-3 py-2 text-sm font-medium" 
                                data-booking-id="${booking.id}" data-current-status="${booking.status}">
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>✅ Confirmed</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>❌ Cancelled</option>
                        </select>
                        <button onclick="viewBookingDetails(${booking.id})" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            👁️ View Details
                        </button>
                    </div>
                </div>
            `;
            
            // Add status change handler
            const statusSelect = div.querySelector('.status-select');
            statusSelect.addEventListener('change', (e) => {
                updateBookingStatus(booking.id, e.target.value);
            });
            
            return div;
        }

        // Update booking status
        async function updateBookingStatus(bookingId, newStatus) {
            try {
                const response = await fetch(`/api/admin/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    loadBookings(); // Reload to show updated status
                } else {
                    alert('Error updating status');
                }
            } catch (error) {
                alert('Error updating status');
            }
        }

        // Update stats
        function updateStats(bookings = []) {
            const total = bookings.length;
            const confirmed = bookings.filter(b => b.status === 'confirmed').length;
            const cancelled = bookings.filter(b => b.status === 'cancelled').length;
            const totalRevenue = bookings
                .filter(b => b.status === 'confirmed')
                .reduce((sum, b) => sum + b.total_price, 0);
            const totalParticipants = bookings
                .filter(b => b.status === 'confirmed')
                .reduce((sum, b) => sum + b.adults + b.children, 0);
            
            // Calculate time-based stats
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = bookings.filter(b => b.tour_date === today).length;
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const thisWeekBookings = bookings.filter(b => new Date(b.created_at) >= weekAgo).length;
            
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const thisMonthBookings = bookings.filter(b => new Date(b.created_at) >= monthAgo).length;
            
            // Update main stats
            document.getElementById('totalBookings').textContent = total;
            document.getElementById('confirmedBookings').textContent = confirmed;
            document.getElementById('totalRevenue').textContent = `€${totalRevenue}`;
            document.getElementById('totalParticipants').textContent = totalParticipants;
            
            // Update dashboard overview
            document.getElementById('todayBookings').textContent = todayBookings;
            document.getElementById('thisWeekBookings').textContent = thisWeekBookings;
            document.getElementById('thisMonthBookings').textContent = thisMonthBookings;
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        // View booking details
        function viewBookingDetails(bookingId) {
            const booking = currentBookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            const details = `
Booking #${booking.id}
Customer: ${booking.customer_name}
Email: ${booking.customer_email}
Phone: ${booking.customer_phone || 'Not provided'}
Tour: ${booking.tour_name}
Date: ${new Date(booking.tour_date).toLocaleDateString('en-GB')}
Participants: ${booking.adults} adults, ${booking.children} children
Total Price: €${booking.total_price}
Status: ${booking.status}
Booked: ${new Date(booking.created_at).toLocaleString('en-GB')}
${booking.special_requests ? `Special Requests: ${booking.special_requests}` : ''}
            `;
            
            alert(details);
        }

        // Export bookings
        function exportBookings() {
            if (!currentBookings || currentBookings.length === 0) {
                alert('No bookings to export');
                return;
            }
            
            const csvContent = [
                ['ID', 'Customer Name', 'Email', 'Phone', 'Tour', 'Date', 'Adults', 'Children', 'Total Price', 'Status', 'Booked At', 'Special Requests'],
                ...currentBookings.map(booking => [
                    booking.id,
                    booking.customer_name,
                    booking.customer_email,
                    booking.customer_phone || '',
                    booking.tour_name || '',
                    new Date(booking.tour_date).toLocaleDateString('en-GB'),
                    booking.adults,
                    booking.children,
                    booking.total_price,
                    booking.status,
                    new Date(booking.created_at).toLocaleString('en-GB'),
                    booking.special_requests || ''
                ])
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `royal-nordic-bookings-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Store current bookings for export
        let currentBookings = [];
        let filteredBookings = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let availabilityData = new Map();

        // Show/hide tour management
        function showTourManagement() {
            const tourManagement = document.getElementById('tourManagement');
            tourManagement.classList.toggle('hidden');
        }

        // Show availability management
        function manageAvailability(tourId) {
            document.getElementById('availabilityManagement').classList.remove('hidden');
            document.getElementById('tourSelect').value = tourId;
            loadAvailabilityData();
        }

        // Hide availability management
        function hideAvailabilityManagement() {
            document.getElementById('availabilityManagement').classList.add('hidden');
        }

        // Edit tour function
        function editTour(tourId) {
            const tourName = tourId === 1 ? 'Northern Lights Tour' : 'Snowshoe Adventure';
            const currentPrices = tourId === 1 ? { adult: 158, child: 79 } : { adult: 95, child: 48 };
            
            const newAdultPrice = prompt(`Edit ${tourName}\n\nCurrent adult price: €${currentPrices.adult}\nEnter new adult price:`, currentPrices.adult);
            if (newAdultPrice && !isNaN(newAdultPrice)) {
                const newChildPrice = prompt(`Enter new child price:`, currentPrices.child);
                if (newChildPrice && !isNaN(newChildPrice)) {
                    // Here you would update the database
                    alert(`Tour updated!\nAdult price: €${newAdultPrice}\nChild price: €${newChildPrice}\n\nNote: This would update the database in a real implementation.`);
                }
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tourFilter = document.getElementById('tourFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredBookings = currentBookings.filter(booking => {
                const matchesSearch = !searchTerm || 
                    booking.customer_name.toLowerCase().includes(searchTerm) ||
                    booking.customer_email.toLowerCase().includes(searchTerm);
                
                const matchesTour = !tourFilter || booking.tour_name === tourFilter;
                const matchesStatus = !statusFilter || booking.status === statusFilter;
                const matchesDate = !dateFilter || booking.tour_date === dateFilter;

                return matchesSearch && matchesTour && matchesStatus && matchesDate;
            });

            displayBookings(filteredBookings);
            updateStats(filteredBookings);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('tourFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            
            filteredBookings = currentBookings;
            displayBookings(currentBookings);
            updateStats(currentBookings);
        }

        // Availability Management Functions
        function loadAvailabilityData() {
            const tourId = document.getElementById('tourSelect').value;
            // This would fetch real data from Supabase
            generateCalendar();
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(Date.UTC(currentYear, currentMonth, 1));
            const lastDay = new Date(Date.UTC(currentYear, currentMonth + 1, 0));
            const startDate = firstDay.getUTCDay();
            const daysInMonth = lastDay.getUTCDate();
            
            grid.innerHTML = '';
            
            // Empty cells for days before month starts
            for (let i = 0; i < startDate; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'h-12';
                grid.appendChild(emptyDiv);
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = new Date(Date.UTC(currentYear, currentMonth, day)).toISOString().split('T')[0];
                const isAvailable = Math.random() > 0.3; // Simulate availability
                const isPast = new Date(dateString) < new Date().setHours(0,0,0,0);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `h-12 flex items-center justify-center text-sm font-medium rounded-lg cursor-pointer transition-colors ${
                    isPast ? 'bg-gray-100 text-gray-400 cursor-not-allowed' :
                    isAvailable ? 'bg-green-100 text-green-800 hover:bg-green-200 border border-green-300' :
                    'bg-red-100 text-red-800 hover:bg-red-200 border border-red-300'
                }`;
                dayDiv.textContent = day;
                dayDiv.onclick = () => toggleAvailability(dateString, isAvailable);
                grid.appendChild(dayDiv);
            }
        }

        function goToPreviousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        }

        function goToNextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
        }

        function toggleAvailability(dateString, currentStatus) {
            const newStatus = !currentStatus;
            // This would update the database
            alert(`Date ${dateString} ${newStatus ? 'enabled' : 'disabled'} for bookings.\n\nNote: This would update the database in a real implementation.`);
            generateCalendar(); // Refresh calendar
        }

        // Add real-time search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', applyFilters);
            }
        });

        // Initialize
        if (authToken) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            loadBookings();
        } else {
            checkAdminExists();
        }
    </script>
</body>
</html>
