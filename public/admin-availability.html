<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Nordic - Tour Availability Management</title>
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .secure-key-input { font-family: monospace; letter-spacing: 2px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Royal Nordic</h1>
                <p class="text-gray-600">Tour Availability Management</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Email Address *</label>
                    <input type="email" id="email" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="your-email@royalnordic.fi">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Password *</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Your password">
                </div>

                <div>
                    <label class="block text-gray-700 font-medium mb-2">Secure Key *</label>
                    <input type="password" id="secureKey" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent secure-key-input"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           maxlength="16">
                    <p class="text-xs text-gray-500 mt-1">16-character security key</p>
                </div>
                
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    Access Availability Management
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">
                    üîí This is a secure, private admin panel.<br>
                    Access is restricted to authorized personnel only.
                </p>
            </div>
        </div>
    </div>

    <!-- Main Availability Management -->
    <div id="availabilityPanel" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Tour Availability Management</h1>
                        <p class="text-sm text-gray-600" id="userInfo"></p>
                    </div>
                    <div class="flex space-x-4">
                        <button id="backToAdmin" class="text-blue-600 hover:text-blue-700 font-medium">‚Üê Back to Admin</button>
                        <button id="logoutBtn" class="text-red-600 hover:text-red-700 font-medium">Secure Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tour Selection -->
        <div class="p-4">
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Select Tour to Manage</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="northernLightsBtn" class="p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors text-left">
                        <h3 class="font-semibold text-gray-900">Northern Lights Tour</h3>
                        <p class="text-sm text-gray-600">Season: Sep 15 - Apr 15</p>
                        <p class="text-sm text-gray-600">Max Capacity: 8 people</p>
                    </button>
                    <button id="snowshoeBtn" class="p-4 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition-colors text-left">
                        <h3 class="font-semibold text-gray-900">Snowshoe Adventure</h3>
                        <p class="text-sm text-gray-600">Season: Nov 1 - Apr 1</p>
                        <p class="text-sm text-gray-600">Max Capacity: 3 people</p>
                    </button>
                </div>
            </div>

            <!-- Availability Management Interface -->
            <div id="availabilityInterface" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900" id="tourTitle">Tour Availability</h2>
                        <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Refresh
                        </button>
                    </div>

                    <!-- Calendar Navigation -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="prevMonth" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">‚Üê</button>
                        <h3 class="text-lg font-semibold text-gray-900" id="currentMonth">January 2025</h3>
                        <button id="nextMonth" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">‚Üí</button>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 mb-4">
                        <div class="text-center text-xs font-medium text-gray-500 py-2">Mon</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">Tue</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">Wed</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">Thu</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">Fri</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">Sat</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">Sun</div>
                    </div>
                    
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                        <!-- Calendar days will be loaded here -->
                    </div>
                </div>

                <!-- Edit Panel -->
                <div id="editPanel" class="hidden bg-white rounded-xl shadow-sm border p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4" id="editTitle">Edit Availability</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Available Slots</label>
                            <input type="number" id="slotsInput" min="0" max="8" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1" id="maxCapacityText">Maximum capacity: 8 people</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="saveBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Save Changes
                            </button>
                            <button id="deleteBtn" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                                Delete Date
                            </button>
                            <button id="cancelBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="bg-white rounded-xl shadow-sm border p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Legend</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-green-50 border border-green-200 rounded"></div>
                            <span class="text-sm text-gray-700">Available (has slots)</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-red-50 border border-red-200 rounded"></div>
                            <span class="text-sm text-gray-700">Full booked (0 slots)</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-gray-50 border border-gray-200 rounded"></div>
                            <span class="text-sm text-gray-700">No availability data</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-gray-200 border border-gray-200 rounded opacity-60"></div>
                            <span class="text-sm text-gray-700">Out of season (closed)</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 bg-gray-100 border border-gray-200 rounded opacity-60"></div>
                            <span class="text-sm text-gray-700">Past dates (read-only)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminToken');
        let currentUser = null;
        let currentTour = null;
        let currentMonth = new Date();
        let availability = [];
        let selectedDate = null;

        // Check authentication
        if (!authToken) {
            document.getElementById('loginScreen').classList.remove('hidden');
        } else {
            document.getElementById('availabilityPanel').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Logged in as: ' + localStorage.getItem('adminEmail') || 'Admin';
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const secureKey = document.getElementById('secureKey').value;
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, secureKey })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('adminToken', authToken);
                    localStorage.setItem('adminEmail', email);
                    
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('availabilityPanel').classList.remove('hidden');
                    document.getElementById('userInfo').textContent = `Logged in as: ${email}`;
                } else {
                    alert('Invalid credentials. Check your email, password, and secure key.');
                }
            } catch (error) {
                alert('Login error');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminEmail');
            
            document.getElementById('availabilityPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form fields
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('secureKey').value = '';
        });

        // Back to admin
        document.getElementById('backToAdmin').addEventListener('click', () => {
            window.location.href = '/admin.html';
        });

        // Tour selection
        document.getElementById('northernLightsBtn').addEventListener('click', () => {
            selectTour(1, 'Northern Lights Tour', 8);
        });

        document.getElementById('snowshoeBtn').addEventListener('click', () => {
            selectTour(2, 'Snowshoe Adventure', 3);
        });

        function selectTour(tourId, tourName, maxCapacity) {
            currentTour = { id: tourId, name: tourName, maxCapacity };
            document.getElementById('tourTitle').textContent = `${tourName} - Availability Management`;
            document.getElementById('maxCapacityText').textContent = `Maximum capacity: ${maxCapacity} people`;
            document.getElementById('availabilityInterface').classList.remove('hidden');
            loadAvailability();
        }

        // Calendar navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            updateCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            updateCalendar();
        });

        // Refresh
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadAvailability();
        });

        // Load availability data
        async function loadAvailability() {
            if (!currentTour) return;
            
            try {
                const response = await fetch(`https://itihdgqgvlphtyidnvkt.supabase.co/functions/v1/get-tour-availability`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWhkZ3FndmxwaHR5aWRudmt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTk2NjQsImV4cCI6MjA3MTYzNTY2NH0.pF02EbMsV2Aj03kiyu8eAGAa0QmQ5jCi5JzncJ5T0Rc',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tourId: currentTour.id })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    availability = data.availableDates || [];
                    updateCalendar();
                } else {
                    console.error('Error loading availability:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading availability:', error);
            }
        }

        // Update calendar display
        function updateCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            // Update month title
            document.getElementById('currentMonth').textContent = 
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Create calendar grid
            const firstDay = new Date(Date.UTC(year, month, 1));
            const lastDay = new Date(Date.UTC(year, month + 1, 0));
            const firstDayOfWeek = firstDay.getUTCDay();
            const daysInMonth = lastDay.getUTCDate();
            
            // Create date map for faster lookup
            const dateMap = new Map();
            availability.forEach(date => {
                dateMap.set(date.date, date);
            });
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Add empty cells for days before the first of the month
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'h-16';
                grid.appendChild(emptyDiv);
            }
            
            // Add all days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = new Date(Date.UTC(year, month, day)).toISOString().split('T')[0];
                const dateData = dateMap.get(dateString);
                
                // Check if date is in the past
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                const isPastDate = dateString < todayString;
                
                // Check if date is in season
                let inSeason = true;
                if (currentTour.id === 1) { // Northern Lights
                    const date = new Date(dateString);
                    const monthNum = date.getMonth() + 1;
                    const dayOfMonth = date.getDate();
                    inSeason = (monthNum === 9 && dayOfMonth >= 15) || 
                               (monthNum >= 10 && monthNum <= 12) || 
                               (monthNum >= 1 && monthNum <= 3) || 
                               (monthNum === 4 && dayOfMonth <= 15);
                } else if (currentTour.id === 2) { // Snowshoe
                    const date = new Date(dateString);
                    const monthNum = date.getMonth() + 1;
                    const dayOfMonth = date.getDate();
                    inSeason = (monthNum === 11 && dayOfMonth >= 1) || 
                               (monthNum === 12) || 
                               (monthNum >= 1 && monthNum <= 3) || 
                               (monthNum === 4 && dayOfMonth <= 1);
                }
                
                const button = document.createElement('button');
                button.className = `h-16 rounded text-sm font-medium transition-colors border ${
                    isPastDate
                        ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed opacity-60'
                        : !inSeason
                        ? 'bg-gray-200 text-gray-500 border-gray-200 cursor-not-allowed opacity-60'
                        : dateData && dateData.availableSpots > 0
                        ? 'bg-green-50 text-green-900 border-green-200 hover:bg-green-100'
                        : dateData
                        ? 'bg-red-50 text-red-900 border-red-200 hover:bg-red-100'
                        : 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100'
                }`;
                
                button.innerHTML = `
                    <div class="text-xs font-bold">${day}</div>
                    <div class="text-xs">
                        ${isPastDate ? 'Past' : !inSeason ? 'Closed' : dateData ? `${dateData.availableSpots} slots` : 'No data'}
                    </div>
                `;
                
                if (!isPastDate && inSeason) {
                    button.addEventListener('click', () => handleDateClick(dateString, dateData?.availableSpots || 0));
                }
                
                grid.appendChild(button);
            }
        }

        // Handle date click
        function handleDateClick(date, currentSlots) {
            selectedDate = date;
            document.getElementById('editTitle').textContent = `Edit Availability for ${new Date(date).toLocaleDateString()}`;
            document.getElementById('slotsInput').value = currentSlots;
            document.getElementById('editPanel').classList.remove('hidden');
        }

        // Save availability
        document.getElementById('saveBtn').addEventListener('click', async () => {
            if (!selectedDate || !currentTour) return;
            
            const slots = parseInt(document.getElementById('slotsInput').value) || 0;
            
            try {
                const response = await fetch(`https://itihdgqgvlphtyidnvkt.supabase.co/functions/v1/update-tour-availability`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWhkZ3FndmxwaHR5aWRudmt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTk2NjQsImV4cCI6MjA3MTYzNTY2NH0.pF02EbMsV2Aj03kiyu8eAGAa0QmQ5jCi5JzncJ5T0Rc',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tourId: currentTour.id,
                        date: selectedDate,
                        availableSlots: slots
                    })
                });
                
                if (response.ok) {
                    alert('Availability updated successfully!');
                    document.getElementById('editPanel').classList.add('hidden');
                    loadAvailability(); // Reload to show changes
                } else {
                    const error = await response.json();
                    alert('Error updating availability: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error updating availability: ' + error.message);
            }
        });

        // Delete availability
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!selectedDate || !currentTour) return;
            
            if (!confirm('Are you sure you want to delete availability for this date?')) return;
            
            try {
                const response = await fetch(`https://itihdgqgvlphtyidnvkt.supabase.co/functions/v1/update-tour-availability`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWhkZ3FndmxwaHR5aWRudmt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTk2NjQsImV4cCI6MjA3MTYzNTY2NH0.pF02EbMsV2Aj03kiyu8eAGAa0QmQ5jCi5JzncJ5T0Rc',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tourId: currentTour.id,
                        date: selectedDate,
                        availableSlots: 0
                    })
                });
                
                if (response.ok) {
                    alert('Availability deleted successfully!');
                    document.getElementById('editPanel').classList.add('hidden');
                    loadAvailability(); // Reload to show changes
                } else {
                    const error = await response.json();
                    alert('Error deleting availability: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting availability: ' + error.message);
            }
        });

        // Cancel edit
        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('editPanel').classList.add('hidden');
            selectedDate = null;
        });
    </script>
</body>
</html>
